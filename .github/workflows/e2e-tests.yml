name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - android
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'

concurrency:
  group: e2e-${{ github.ref }}-${{ github.event.inputs.platform || 'ios' }}
  cancel-in-progress: true

jobs:
  # iOS Simulator Tests
  test-ios:
    name: iOS Simulator Test
    runs-on: macos-14
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == '' || github.event_name == 'schedule'
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Expo dependencies
        run: npx expo install

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            pods-

      - name: Run Expo prebuild for iOS
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Boot iOS Simulator
        run: |
          # Find an iPhone 15 Pro simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | grep -oE "[A-F0-9-]{36}")
          if [ -z "$SIMULATOR_ID" ]; then
            # Fallback to any iPhone
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE "[A-F0-9-]{36}")
          fi
          echo "Using simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true
          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV

      - name: Build iOS app for simulator
        run: |
          xcodebuild -workspace ios/neighborfood.xcworkspace \
            -scheme neighborfood \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=${{ env.SIMULATOR_ID }}" \
            -derivedDataPath build \
            build
        timeout-minutes: 30

      - name: Install app on simulator
        run: |
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          echo "Installing app from: $APP_PATH"
          xcrun simctl install "${{ env.SIMULATOR_ID }}" "$APP_PATH"

      - name: Launch app
        run: |
          xcrun simctl launch "${{ env.SIMULATOR_ID }}" com.neighborfood.app || true
          sleep 10

      - name: Take screenshot
        run: |
          xcrun simctl io "${{ env.SIMULATOR_ID }}" screenshot screenshot.png
          echo "Screenshot captured"

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-screenshot
          path: screenshot.png
          retention-days: 7

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_ID }}" || true

  # Android Emulator Tests
  test-android:
    name: Android Emulator Test
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android'
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Expo dependencies
        run: npx expo install

      - name: Run Expo prebuild for Android
        run: npx expo prebuild --platform android --clean

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-

      - name: Build Android Debug APK
        working-directory: android
        run: ./gradlew assembleDebug

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Android Emulator Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            adb install android/app/build/outputs/apk/debug/app-debug.apk
            adb shell am start -n com.neighborfood.app/.MainActivity
            sleep 15
            adb exec-out screencap -p > screenshot.png
            echo "Android app launched successfully"

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: android-emulator-screenshot
          path: screenshot.png
          retention-days: 7
